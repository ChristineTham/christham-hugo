const defaultOptions={captionContent:".pswp-caption-content",type:"auto",horizontalEdgeThreshold:20,mobileCaptionOverlapRatio:.3,mobileLayoutBreakpoint:600};class PhotoSwipeDynamicCaption{constructor(e,t){this.options={...defaultOptions,...t},this.lightbox=e,this.lightbox.on("init",()=>{this.pswp=this.lightbox.pswp,this.initCaption()})}initCaption(){const{pswp:e}=this;e.on("change",()=>{this.showCaption(this.pswp.currSlide)}),e.on("calcSlideSize",e=>this.onCalcSlideSize(e)),e.on("slideDestroy",e=>{e.slide.dynamicCaption&&(e.slide.dynamicCaption.element&&e.slide.dynamicCaption.element.remove(),delete e.slide.dynamicCaption)}),e.on("zoomPanUpdate",({slide:t})=>{if(e.opener.isOpen&&t.dynamicCaption&&(t.currZoomLevel>t.zoomLevels.initial?this.hideCaption(t):this.showCaption(t),t.dynamicCaption.element)){let e=0;if(t.currZoomLevel<=t.zoomLevels.initial){const n=t.pan.y-t.bounds.center.y;Math.abs(n)>1&&(e=n)}this.setCaptionYOffset(t.dynamicCaption.element,e)}}),e.on("beforeZoomTo",t=>{const{currSlide:n}=e;n.dynamicCaption&&n.dynamicCaption.adjustedPanAreaSize&&(t.destZoomLevel>n.zoomLevels.initial?(n.panAreaSize.x=n.dynamicCaption.originalPanAreaSize.x,n.panAreaSize.y=n.dynamicCaption.originalPanAreaSize.y):(n.panAreaSize.x=n.dynamicCaption.adjustedPanAreaSize.x,n.panAreaSize.y=n.dynamicCaption.adjustedPanAreaSize.y))}),e.on("tapAction",e=>{e.originalEvent.target.closest(".pswp__dynamic-caption")&&e.preventDefault()})}useMobileLayout(){const{mobileLayoutBreakpoint:e}=this.options;return typeof e=="function"?e.call(this):typeof e=="number"&&window.innerWidth<e}hideCaption(e){if(e.dynamicCaption&&!e.dynamicCaption.hidden){const t=e.dynamicCaption.element;if(!t)return;e.dynamicCaption.hidden=!0,t.classList.add("pswp__dynamic-caption--faded"),e.captionFadeTimeout&&clearTimeout(e.captionFadeTimeout),e.captionFadeTimeout=setTimeout(()=>{t.style.visibility="hidden",delete e.captionFadeTimeout},400)}}setCaptionYOffset(e,t){e.style.transform=`translateY(${t}px)`}showCaption(e){if(e.dynamicCaption&&e.dynamicCaption.hidden){const t=e.dynamicCaption.element;if(!t)return;e.dynamicCaption.hidden=!1,t.style.visibility="visible",clearTimeout(e.captionFadeTimeout),e.captionFadeTimeout=setTimeout(()=>{t.classList.remove("pswp__dynamic-caption--faded"),delete e.captionFadeTimeout},50)}}setCaptionPosition(e,t,n){const s=t<=this.options.horizontalEdgeThreshold;e.classList[s?"add":"remove"]("pswp__dynamic-caption--on-hor-edge"),e.style.left=t+"px",e.style.top=n+"px"}setCaptionWidth(e,t){t?e.style.width=t+"px":e.style.removeProperty("width")}setCaptionType(e,t){const n=e.dataset.pswpCaptionType;t!==n&&(e.classList.add("pswp__dynamic-caption--"+t),e.classList.remove("pswp__dynamic-caption--"+n),e.dataset.pswpCaptionType=t)}updateCaptionPosition(e){if(!e.dynamicCaption||!e.dynamicCaption.type||!e.dynamicCaption.element)return;if(e.dynamicCaption.type==="mobile"){this.setCaptionType(e.dynamicCaption.element,e.dynamicCaption.type),e.dynamicCaption.element.style.removeProperty("left"),e.dynamicCaption.element.style.removeProperty("top"),this.setCaptionWidth(e.dynamicCaption.element,!1);return}const t=e.zoomLevels.initial,n=Math.ceil(e.width*t),s=Math.ceil(e.height*t);this.setCaptionType(e.dynamicCaption.element,e.dynamicCaption.type),e.dynamicCaption.type==="aside"?(this.setCaptionPosition(e.dynamicCaption.element,e.bounds.center.x+n,e.bounds.center.y),this.setCaptionWidth(e.dynamicCaption.element,!1)):e.dynamicCaption.type==="below"&&(this.setCaptionPosition(e.dynamicCaption.element,e.bounds.center.x,e.bounds.center.y+s),this.setCaptionWidth(e.dynamicCaption.element,n))}onCalcSlideSize(e){const{slide:t}=e;let n,s;if(!t.dynamicCaption){t.dynamicCaption={element:void 0,type:!1,hidden:!1};const e=this.getCaptionHTML(t);if(!e)return;t.dynamicCaption.element=document.createElement("div"),t.dynamicCaption.element.className="pswp__dynamic-caption pswp__hide-on-close",t.dynamicCaption.element.innerHTML=e,this.pswp.dispatch("dynamicCaptionUpdateHTML",{captionElement:t.dynamicCaption.element,slide:t}),t.holderElement.appendChild(t.dynamicCaption.element)}if(!t.dynamicCaption.element)return;this.storeOriginalPanAreaSize(t),t.bounds.update(t.zoomLevels.initial),this.useMobileLayout()?(t.dynamicCaption.type="mobile",s=!0):this.options.type==="auto"?t.bounds.center.x>t.bounds.center.y?t.dynamicCaption.type="aside":t.dynamicCaption.type="below":t.dynamicCaption.type=this.options.type;const o=Math.ceil(t.width*t.zoomLevels.initial),i=Math.ceil(t.height*t.zoomLevels.initial);if(this.setCaptionType(t.dynamicCaption.element,t.dynamicCaption.type),t.dynamicCaption.type==="aside"){this.setCaptionWidth(t.dynamicCaption.element,!1),n=this.measureCaptionSize(t.dynamicCaption.element,e.slide);const s=n.x,i=o+t.bounds.center.x,a=t.panAreaSize.x-i;a<=s&&(t.panAreaSize.x-=s,this.recalculateZoomLevelAndBounds(t))}else if(t.dynamicCaption.type==="below"||s){this.setCaptionWidth(t.dynamicCaption.element,s?this.pswp.viewportSize.x:o),n=this.measureCaptionSize(t.dynamicCaption.element,e.slide);const a=n.y,c=i+t.bounds.center.y,r=t.panAreaSize.y-c,l=t.panAreaSize.y;if(r<=a){t.panAreaSize.y-=Math.min((a-r)*2,a),this.recalculateZoomLevelAndBounds(t);const e=t.panAreaSize.x*this.options.mobileCaptionOverlapRatio/2;s&&t.bounds.center.x>e&&(t.panAreaSize.y=l,this.recalculateZoomLevelAndBounds(t))}}this.storeAdjustedPanAreaSize(t),this.updateCaptionPosition(t)}measureCaptionSize(e,t){const n=e.getBoundingClientRect(),s=this.pswp.dispatch("dynamicCaptionMeasureSize",{captionEl:e,slide:t,captionSize:{x:n.width,y:n.height}});return s.captionSize}recalculateZoomLevelAndBounds(e){e.zoomLevels.update(e.width,e.height,e.panAreaSize),e.bounds.update(e.zoomLevels.initial)}storeAdjustedPanAreaSize(e){e.dynamicCaption&&(e.dynamicCaption.adjustedPanAreaSize||(e.dynamicCaption.adjustedPanAreaSize={}),e.dynamicCaption.adjustedPanAreaSize.x=e.panAreaSize.x,e.dynamicCaption.adjustedPanAreaSize.y=e.panAreaSize.y)}storeOriginalPanAreaSize(e){e.dynamicCaption&&(e.dynamicCaption.originalPanAreaSize||(e.dynamicCaption.originalPanAreaSize={}),e.dynamicCaption.originalPanAreaSize.x=e.panAreaSize.x,e.dynamicCaption.originalPanAreaSize.y=e.panAreaSize.y)}getCaptionHTML(e){if(typeof this.options.captionContent=="function")return this.options.captionContent.call(this,e);const t=e.data.element;let n="";if(t){const e=t.querySelector(this.options.captionContent);if(e)n=e.innerHTML;else{const e=t.querySelector("img");e&&(n=e.getAttribute("alt"))}}return n}}export default PhotoSwipeDynamicCaption